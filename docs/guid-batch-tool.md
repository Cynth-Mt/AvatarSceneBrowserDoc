# GUID批量更新工具

## 概述

GUID批量更新工具是Avatar Scene Browser的配套维护工具，专门用于检查和修复`scenes_data.json`文件中记录的场景GUID数据和路径信息。它能够自动检测GUID相关问题并提供一键修复功能，是保持系统数据完整性的重要工具。

## 访问工具

有两种方式可以打开GUID批量更新工具：

### 方法一：快捷方式（推荐）
在Avatar Scene Browser主窗口顶部，点击蓝色的 **"GUID工具"** 按钮

### 方法二：菜单方式
通过Unity菜单 `Tools → Avatar_Scene_Browser → GUID Batch Update Tool`

## 主要功能

### 数据检查功能
- 🔍 **完整性检查**：扫描所有场景数据的GUID和路径状态
- 📊 **统计报告**：提供详细的问题分类统计
- 🚨 **问题识别**：自动识别文件缺失、路径不匹配、GUID错误等问题

### 修复功能
- 🔧 **智能修复**：根据问题类型自动选择最佳修复方案
- 🔄 **批量处理**：一键修复所有检测到的问题
- 🎯 **单项修复**：针对个别场景进行精确修复
- 📈 **进度显示**：修复过程中显示详细进度条

### 数据管理
- 👁️ **实时预览**：显示记录路径与实际路径的对比
- 🎨 **颜色编码**：通过颜色直观显示不同问题类型
- 📋 **过滤显示**：可选择只显示有问题的条目

## 界面说明

### 工具栏
- **检查数据** - 重新加载并分析`scenes_data.json`，显示详细的问题统计报告
- **修复所有问题** - 修复所有检测到的GUID和路径问题
- **仅显示问题项** - 过滤显示，只显示有问题的条目

### 数据列表

工具主界面显示一个详细的数据表格：

| 列名 | 说明 |
|------|------|
| **记录路径** | `scenes_data.json`中记录的场景路径 |
| **实际路径** | 通过GUID获取的实际场景路径 |
| **状态** | 问题类型标识（正常/需更新/文件缺失/无GUID/异常）|
| **当前GUID** | 记录的GUID值 |
| **实际GUID** | 从实际文件获取的GUID值 |
| **操作** | 智能修复按钮（根据问题类型自动调整按钮文本）|

## 状态类型详解

### 🟢 正常
- **含义**：GUID正确，文件存在，路径匹配
- **显示**：绿色背景
- **操作**：无需处理

### 🟡 需更新
- **含义**：文件存在但GUID不匹配，或路径记录过时
- **显示**：黄色背景
- **操作**：点击"更新"按钮修复

### 🔴 文件缺失
- **含义**：Scene文件不存在，可能已被删除或移动到其他位置
- **显示**：红色背景
- **操作**：需要手动处理（找回文件或删除记录）

### 🟡 无GUID
- **含义**：`scenes_data.json`中没有记录GUID（旧版本数据）
- **显示**：黄色背景
- **操作**：点击"添加GUID"按钮补充

### ⚪ 异常
- **含义**：其他异常情况
- **显示**：默认背景色
- **操作**：根据具体情况处理

## 使用场景与操作流程

### 1. 定期维护检查

**建议频率**：每周一次

**操作步骤**：
```
1. 打开GUID批量更新工具
   ↓
2. 点击"检查数据"
   ↓
3. 查看统计信息和问题报告
   ↓
4. 如有问题，点击"修复所有问题"
   ↓
5. 确认修复结果
```

### 2. 文件重命名后的数据修复

**场景**：重命名了Scene文件后需要更新记录

**操作步骤**：
```
1. 打开GUID批量更新工具
   ↓
2. 勾选"仅显示问题项"
   ↓
3. 点击"修复所有问题"
   ↓
4. 验证修复结果
```

### 3. 项目迁移后的数据检查

**场景**：项目迁移或重新导入后

**操作步骤**：
```
1. 打开GUID批量更新工具
   ↓
2. 点击"检查数据"
   ↓
3. 检查是否有GUID问题
   ↓
4. 根据需要进行批量或单个修复
```

### 4. 单个问题的精确修复

**场景**：只有个别场景有问题

**操作步骤**：
```
1. 打开工具并检查数据
   ↓
2. 在列表中找到问题场景
   ↓
3. 点击该行的"修复"按钮
   ↓
4. 确认修复完成
```

## 批量修复详细流程

### 确认对话框
点击"修复所有问题"后，系统会显示确认对话框：
- 📊 显示将要修复的问题数量
- ⏱️ 预估修复所需时间
- ⚠️ 提醒用户确认操作

### 修复进度
修复过程中会显示：
- 📈 **总体进度条**：显示整体完成百分比
- 📝 **当前操作**：显示正在处理的场景名称
- ⏱️ **实时状态**：显示已完成和剩余数量
- ❌ **取消选项**：用户可随时取消操作

### 修复结果
完成后显示详细统计：
- ✅ 成功修复的项目数量
- ❌ 修复失败的项目数量（如果有）
- 📄 详细的修复日志

## 技术细节

### 检测逻辑

工具对每个场景数据进行以下检查：

1. **文件存在性检查**
   ```csharp
   bool fileExists = File.Exists(scenePath);
   ```

2. **GUID有效性验证**
   ```csharp
   string validGuid = AssetDatabase.AssetPathToGUID(scenePath);
   bool guidValid = !string.IsNullOrEmpty(validGuid);
   ```

3. **GUID一致性比较**
   ```csharp
   bool guidMatches = (sceneData.sceneGUID == actualGuid);
   ```

### 修复逻辑

修复过程包括以下步骤：

1. **获取正确GUID**
   ```csharp
   string correctGuid = AssetDatabase.AssetPathToGUID(scenePath);
   ```

2. **更新数据结构**
   ```csharp
   sceneData.sceneGUID = correctGuid;
   sceneData.scenePath = currentPath; // 更新路径缓存
   ```

3. **重构数据字典**
   ```csharp
   // 从路径键改为GUID键
   scenesData[correctGuid] = sceneData;
   ```

4. **保存更新**
   ```csharp
   DataSerializer.SaveSceneData(updatedData);
   ```

## 数据备份与恢复

### 自动备份
工具在执行批量修复前会自动创建备份：
- 📁 备份位置：`Data/Backup/`
- 📅 备份命名：`scenes_data_backup_YYYYMMDD_HHMMSS.json`
- 🔄 保留最近5个备份文件

### 手动备份建议
在重要操作前建议手动备份：
```
复制整个 Avatar_Scene_Browser/Data/ 文件夹到安全位置
```

## 故障排除

### 常见问题与解决方案

#### Q: 修复后还是显示有问题？
**解决方案**：
1. 点击"检查数据"重新加载
2. 检查场景文件是否真的存在于记录路径
3. 确认Unity项目状态正常
4. 重启Unity编辑器

#### Q: 为什么有些场景显示"文件缺失"？
**原因分析**：
- Scene文件已被删除
- Scene文件被移动到其他位置
- 文件权限问题导致无法访问

**解决方案**：
- 找回原始文件并放回原位置
- 或从`scenes_data.json`中删除这些无效记录

#### Q: 批量修复被中断了怎么办？
**解决方案**：
1. 检查控制台错误信息
2. 重新运行工具检查当前状态
3. 使用备份文件恢复（如果需要）
4. 逐个修复剩余问题

#### Q: 可以撤销修复操作吗？
**说明**：目前不支持一键撤销功能

**建议**：
- 修复前手动备份数据文件
- 使用自动备份文件恢复到修复前状态
- 重要项目在修复前创建完整的项目备份

## 最佳实践

### 使用建议
1. **定期维护**：建议每周运行一次检查
2. **操作前备份**：重要项目在批量修复前手动备份
3. **团队协作**：团队成员应定期同步和检查GUID状态
4. **版本控制**：将`scenes_data.json`纳入版本控制管理

### 性能优化
- **大项目处理**：超过100个场景的项目建议分批处理
- **网络项目**：确保网络稳定，避免修复过程中断
- **存储空间**：定期清理过期的备份文件

### 团队协作建议
- **统一版本**：确保团队使用相同版本的插件
- **数据同步**：定期同步`scenes_data.json`文件
- **冲突解决**：发生冲突时使用工具重新检查和修复

---

GUID批量更新工具是Avatar Scene Browser生态系统的重要组成部分，它确保了GUID追踪系统的长期稳定性和数据完整性。定期使用这个工具可以有效避免数据丢失问题，让您的场景管理工作更加可靠和高效。 